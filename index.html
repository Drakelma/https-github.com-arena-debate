<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deep Sports Debate Arena · Quick-Fire</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0a0a0a; color:#f1f1f1; }
    .wrap { max-width: 1000px; margin: 0 auto; padding: 24px; }
    .card { background:#121212; border:1px solid #232323; border-radius: 16px; padding:16px; box-shadow: 0 10px 30px rgba(0,0,0,.3); }
    .row { display:grid; gap:16px; }
    @media (min-width: 900px) { .row-2 { grid-template-columns: 1fr 1fr; } .row-3 { grid-template-columns: 2fr 1fr; } }
    .btn { background:#1e1e1e; border:1px solid #2a2a2a; border-radius:12px; padding:10px 14px; color:#eaeaea; cursor:pointer }
    .btn:hover { background:#2a2a2a; }
    .btn-cta { background:#34d399; color:#000; border:none; font-weight:700; }
    .btn-cta[disabled] { background:#3a3a3a; color:#9a9a9a; cursor:not-allowed; }
    .pill { font-size:12px; text-transform:uppercase; letter-spacing:.08em; color:#a1a1a1 }
    .h1 { font-size:28px; font-weight:800; }
    .muted { color:#9a9a9a; }
    .list { display:grid; gap:8px; }
    .item { display:flex; justify-content:space-between; align-items:center; gap:12px; background:#1a1a1a; border:1px solid #2a2a2a; padding:10px 12px; border-radius:10px; }
    .stack { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .feed { max-height:180px; overflow:auto; display:grid; gap:8px; }
    .chip { background:#262626; padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid #333; }
    .select, select, .timer { background:#111; border:1px solid #2a2a2a; color:#eaeaea; border-radius:12px; padding:8px 10px; }
    .verdict { background:#1f2937; border:1px solid #334155; padding:12px; border-radius:12px; }
    .link { font-size:12px; color:#93c5fd; text-decoration: underline; cursor:pointer }
    .footer { color:#9a9a9a; text-align:center; margin-top:12px; font-size:13px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="row" style="grid-template-columns: 1fr auto; align-items:center; margin-bottom:16px">
      <div class="h1">Deep Sports Debate Arena · Quick-Fire</div>
      <div class="stack">
        <label class="muted" for="topicSel">Topic</label>
        <select id="topicSel" class="select"></select>
        <select id="persona" class="select">
          <option>Rowdy Pub</option>
          <option>Respectful Analysts</option>
          <option>Talk Radio</option>
        </select>
        <button class="btn" id="resetBtn">Reset</button>
      </div>
    </header>

    <section class="card">
      <div class="pill">Topic</div>
      <div id="topicTitle" style="font-size:22px; font-weight:700; margin-top:4px"></div>

      <div class="row row-2" style="margin-top:12px">
        <div class="card" style="background:#181818">
          <div class="muted" style="font-size:13px">Side A</div>
          <div style="font-size:18px; font-weight:600" id="sideA"></div>
          <button id="joinA" class="btn" style="margin-top:8px">Join Side A</button>
        </div>
        <div class="card" style="background:#181818">
          <div class="muted" style="font-size:13px">Side B</div>
          <div style="font-size:18px; font-weight:600" id="sideB"></div>
          <button id="joinB" class="btn" style="margin-top:8px">Join Side B</button>
        </div>
      </div>

      <div class="stack" style="margin-top:12px">
        <button id="startBtn" class="btn btn-cta" disabled>Start Debate</button>
        <div class="stack" id="roundControls" style="display:none">
          <div class="timer" id="timer">45s</div>
          <button class="btn" id="endRoundBtn">End Round</button>
          <select id="roundLength" class="select">
            <option value="30">30s</option>
            <option value="45" selected>45s</option>
            <option value="60">60s</option>
          </select>
        </div>
      </div>
    </section>

    <section class="row row-3" style="margin-top:16px">
      <div class="card">
        <div class="pill">Preloaded Facts</div>
        <div class="list" id="facts"></div>
        <div class="pill" style="margin-top:10px">Derived Ratings</div>
        <div class="list" id="derived"></div>
      </div>

      <div class="card">
        <div>
          <div class="pill">AI Moderator</div>
          <div class="feed" id="modFeed"><div class="muted">Waiting for debate…</div></div>
        </div>
        <div style="margin-top:12px">
          <div class="pill">AI Crowd · <span id="personaLabel">Rowdy Pub</span></div>
          <div class="feed" id="crowdFeed"><div class="muted">The stands will roar when the debate starts…</div></div>
        </div>
        <div id="verdictBox" class="verdict" style="display:none; margin-top:12px">
          <div class="pill">Verdict</div>
          <div id="verdictText" style="margin-top:4px; font-size:16px; font-weight:600"></div>
          <div class="muted" style="margin-top:6px">Share this debate: <span id="shareLink" class="link"></span></div>
        </div>
      </div>
    </section>

    <div class="footer">v0.1 • Static • topics.json powered</div>
  </div>

  <script>
    const crowdLines = {
      "Rowdy Pub": ["Bosh! Say it with your chest!","Bottle jobs!","Stats don't lie... or do they?","He's cooked!","Net spend tax incoming!"],
      "Respectful Analysts": ["Interesting point on age profile.","Please cite a source for that claim.","Small sample size caveat applies.","Consider fixture congestion effects.","Good argument structure."],
      "Talk Radio": ["Cut the waffle—who's the winner?","Hot take alert!","This is not for the purists!","Phone-in lines are melting!","Producer says keep it moving!"]
    };
    const modPrompts = [
      "Moderator: Opening statements—keep it tight.",
      "Address value vs. cost: who got more per euro?",
      "Counter the tactical fit argument with a concrete example.",
      "Consider injury history: does it change your view?",
      "What about resale value in 2–3 years?",
      "Compare to last season's window—progress or repeat mistakes?"
    ];

    // DOM refs
    const personaSel = document.getElementById('persona');
    const personaLabel = document.getElementById('personaLabel');
    const topicSel = document.getElementById('topicSel');
    const topicTitle = document.getElementById('topicTitle');
    const sideA = document.getElementById('sideA');
    const sideB = document.getElementById('sideB');
    const joinA = document.getElementById('joinA');
    const joinB = document.getElementById('joinB');
    const startBtn = document.getElementById('startBtn');
    const roundControls = document.getElementById('roundControls');
    const timerEl = document.getElementById('timer');
    const endRoundBtn = document.getElementById('endRoundBtn');
    const roundLengthSel = document.getElementById('roundLength');
    const factsEl = document.getElementById('facts');
    const derivedEl = document.getElementById('derived');
    const crowdFeed = document.getElementById('crowdFeed');
    const modFeed = document.getElementById('modFeed');
    const resetBtn = document.getElementById('resetBtn');
    const verdictBox = document.getElementById('verdictBox');
    const verdictText = document.getElementById('verdictText');
    const shareLink = document.getElementById('shareLink');

    // State
    let topics = [];
    let current = 0;
    let joinedSide = null; // 'A' | 'B' | null
    let round = 0; // 0 lobby, 1..2 active, 99 verdict
    let usedStats = new Set();
    let aScore = 0, bScore = 0;
    let tick = null;
    let t = 45;
    let crowdTicker = null;

    // Helpers
    function randomPick(arr){ return arr[Math.floor(Math.random()*arr.length)] }
    function addCrowd(line) { const div = document.createElement('div'); div.className='chip'; div.textContent=line; crowdFeed.prepend(div); while (crowdFeed.children.length>8) crowdFeed.removeChild(crowdFeed.lastChild); }
    function addMod(line) { const div = document.createElement('div'); div.className='chip'; div.textContent=line; modFeed.prepend(div); while (modFeed.children.length>8) modFeed.removeChild(modFeed.lastChild); }
    function uiRenderLists(topic) {
      factsEl.innerHTML=''; topic.facts?.forEach(s=>{ const li=document.createElement('div'); li.className='item'; li.innerHTML=`<div><div>${s.label}</div><div class="muted" style="font-size:13px">${s.value}</div></div><button class="btn">Use as Stat Drop</button>`; li.querySelector('button').onclick=()=>dropStat(`${s.label}:${s.value}`); factsEl.appendChild(li); });
      derivedEl.innerHTML=''; topic.derived?.forEach(s=>{ const li=document.createElement('div'); li.className='item'; li.innerHTML=`<div><div>${s.label}</div><div class="muted" style="font-size:13px">${s.value}</div></div><button class="btn">Use as Stat Drop</button>`; li.querySelector('button').onclick=()=>dropStat(`${s.label}:${s.value}`); derivedEl.appendChild(li); });
    }
    function startCrowdTicker() { if (crowdTicker) clearInterval(crowdTicker); crowdTicker = setInterval(()=>{ addCrowd(randomPick(crowdLines[personaSel.value])); }, 2500); }
    function stopCrowdTicker() { if (crowdTicker) clearInterval(crowdTicker); crowdTicker = null; }

    // Flow
    function applyTopic(i) {
      current = i;
      const topic = topics[i];
      topicTitle.textContent = topic.title;
      sideA.textContent = topic.sides[0];
      sideB.textContent = topic.sides[1];
      uiRenderLists(topic);
      // update share link with ?topic=i
      const url = new URL(window.location.href);
      url.searchParams.set('topic', String(i));
      shareLink.textContent = url.toString();
      shareLink.onclick = () => navigator.clipboard.writeText(url.toString());
    }

    function startDebate() {
      if (!joinedSide) return;
      round = 1; usedStats.clear(); aScore = 0; bScore = 0;
      crowdFeed.innerHTML = ''; modFeed.innerHTML = '';
      addMod("Moderator: Opening statements—keep it tight.");
      verdictBox.style.display = 'none';
      startCrowdTicker();
      t = parseInt(roundLengthSel.value, 10); timerEl.textContent = t + 's';
      tick = setInterval(()=>{ t--; timerEl.textContent = t + 's'; if (t<=0) endRound(); }, 1000);
      startBtn.disabled = true;
      roundControls.style.display = 'flex';
    }

    function endRound() {
      if (round===0 || round===99) return;
      if (tick) { clearInterval(tick); tick = null; }
      if (round >= 2) {
        round = 99;
        stopCrowdTicker();
        const statWeight = usedStats.size * 2;
        const base = Math.floor(Math.random()*100);
        const tilt = joinedSide==='A' ? statWeight : joinedSide==='B' ? -statWeight : 0;
        const final = base + tilt;
        if (final >= 50) { aScore = 100-final; bScore = final; } else { aScore = final; bScore = 100-final; }
        const topic = topics[current];
        const winner = aScore > bScore ? topic.sides[0] : topic.sides[1];
        verdictText.textContent = `Winner: ${winner}. Best moment: ${crowdFeed.firstChild ? crowdFeed.firstChild.textContent : '—'}`;
        verdictBox.style.display = 'block';
        addMod('Moderator: Verdict time—simulated audience has spoken.');
        roundControls.style.display = 'none';
        return;
      }
      round++;
      addMod(randomPick(modPrompts.slice(1)));
      t = parseInt(roundLengthSel.value, 10); timerEl.textContent = t + 's';
      tick = setInterval(()=>{ t--; timerEl.textContent = t + 's'; if (t<=0) endRound(); }, 1000);
    }

    function dropStat(key) {
      if (!joinedSide || usedStats.has(key)) return;
      usedStats.add(key);
      const topic = topics[current];
      const sideName = joinedSide === 'A' ? topic.sides[0] : topic.sides[1];
      addCrowd(`Stat drop by ${sideName} → ${key}`);
    }

    // Events
    personaSel.onchange = () => { document.getElementById('personaLabel').textContent = personaSel.value; };
    joinA.onclick = () => { joinedSide = 'A'; joinA.textContent = 'Joined'; joinB.textContent = 'Join Side B'; startBtn.disabled = false; };
    joinB.onclick = () => { joinedSide = 'B'; joinB.textContent = 'Joined'; joinA.textContent = 'Join Side A'; startBtn.disabled = false; };
    startBtn.onclick = startDebate;
    endRoundBtn.onclick = endRound;
    resetBtn.onclick = () => {
      joinedSide = null; round = 0; usedStats.clear(); aScore = bScore = 0;
      startBtn.disabled = true; roundControls.style.display = 'none'; verdictBox.style.display = 'none';
      crowdFeed.innerHTML = '<div class="muted">The stands will roar when the debate starts…</div>';
      modFeed.innerHTML = '<div class="muted">Waiting for debate…</div>';
      stopCrowdTicker();
      joinA.textContent = 'Join Side A'; joinB.textContent = 'Join Side B';
    };

    // Boot
    (async function boot(){
      try {
        const res = await fetch('./topics.json', { cache: 'no-store' });
        topics = await res.json();
        // populate selector
        topicSel.innerHTML = topics.map((t, i) => `<option value="${i}">${t.title}</option>`).join('');
        // preselect from URL ?topic=i
        const url = new URL(window.location.href);
        const idx = parseInt(url.searchParams.get('topic') || '0', 10);
        const safeIdx = Number.isFinite(idx) && idx >= 0 && idx < topics.length ? idx : 0;
        topicSel.value = String(safeIdx);
        applyTopic(safeIdx);
        topicSel.onchange = (e) => applyTopic(parseInt(e.target.value, 10));
      } catch (e) {
        topicTitle.textContent = 'Failed to load topics.json';
      }
    })();
  </script>
</body>
</html>
